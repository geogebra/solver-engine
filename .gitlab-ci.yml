default:
  image: gradle:jdk19-alpine

variables:
  GITLAB_CLUSTER: solver-v2

stages:
  - lint
  - assemble
  - publish
  - deploy
  - before-undeploy
  - undeploy

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - export SLUG=`echo $CI_COMMIT_REF_SLUG | sed 's/^\([a-z][a-z]*\-[0-9][0-9]*\).*/\1/'`
  - export REPO_FULL_NAME=`echo $CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME`
  - export REPOSITORY_ID=4 # The gitlab ID of the repository where our container images are uploaded

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches

assemble:
  stage: assemble
  tags:
    - docker
  script:
    - ./gradlew assemble
    - ./gradlew test --stacktrace
    - SOLVER_STEPS_TYPE=data ./gradlew test --stacktrace
  artifacts:
    paths:
      - methods/build/generated/ksp/main/resources/TranslationKeys.json
      - engine/build/generated/ksp/main/resources/TranslationKeys.json
    expire_in: 1 day

check-circular-dependencies-in-methods:
  stage: lint
  script:
    - ./scripts/check_method_dependencies.sh

code_style:
  stage: lint
  tags:
    - docker
  script:
    - ./gradlew ktlintCheck
  artifacts:
    paths:
      - build/reports/ktlint
    expire_in: 1 day

static_analysis:
  stage: lint
  tags:
    - docker
  script:
    - ./gradlew detekt
  artifacts:
    paths:
      - build/reports/detekt
    expire_in: 1 day
  allow_failure: true

package:
  stage: publish
  tags:
    - docker
  script:
    - ./gradlew bootBuildImage --imageName="registry.git.geogebra.org/solver-team/solver-engine/api:$SLUG"

export-translation-keys:
  stage: publish
  image: curlimages/curl
  tags:
    - docker
  script:
    # Translation keys from the methods module (most keys)
    - |
      curl -X POST 'https://dev.geogebra.org/ggbtrans/props/api/solver_import/?override_test=1' \
        --fail-with-body \
        --header "X-Token: $GGBTRANS_API_TOKEN" \
        --data @methods/build/generated/ksp/main/resources/TranslationKeys.json
    # Generic translation keys from the engine module
    - |
      curl -X POST 'https://dev.geogebra.org/ggbtrans/props/api/solver_import/?override_test=1' \
        --fail-with-body \
        --header "X-Token: $GGBTRANS_API_TOKEN" \
        --data @engine/build/generated/ksp/main/resources/TranslationKeys.json

  when: manual

deploy:
  stage: deploy
  image: alpine/k8s:1.23.7
  tags:
    - docker
  script:
    - kubectl config get-contexts
    - kubectl config use-context $REPO_FULL_NAME:$GITLAB_CLUSTER
    - helm package helm/ --version "6.6.6"
    - |
      helm upgrade --install $SLUG solver-6.6.6.tgz \
          --set branchName=$SLUG \
          --set commitSha=$CI_COMMIT_SHA \
          --set imageCredentials.username=$CI_REGISTRY_USER \
          --set imageCredentials.password=$CI_REGISTRY_PASSWORD \
          --set springProfile=production

# Merge-request pipeline jobs
wait:
  stage: before-undeploy
  script:
    - echo "Block the pipeline until the next job (undeploy) run"
  only:
    - merge_requests

undeploy:
  stage: undeploy
  image: alpine/k8s:1.23.7
  tags:
    - docker
  script:
    - echo "Attempting do delete tag $SLUG..."
    # Call the gitlab API to delete the image tag as it is no longer needed. This will allow the image
    # to be garbage-collected, saving space on the container registry.
    - |
      curl --request DELETE \
           --header "PRIVATE-TOKEN: $GITLAB_API_PRIVATE_TOKEN" \
           "$CI_API_V4_URL/projects/$CI_PROJECT_ID/registry/repositories/$REPOSITORY_ID/tags/$SLUG"
    - kubectl config get-contexts
    - kubectl config use-context $REPO_FULL_NAME:$GITLAB_CLUSTER
    - helm uninstall $SLUG
  when: manual
  allow_failure: false
  only:
    - merge_requests
